{% import 'macros/form.html' as form %}

{% block scripts %}
  {% resource 'orgportals/map-settings.js' %}
{% endblock %}

{% set data = data or {} %}
{% set errors = errors or {} %}

{% if page %}
  {% set action_url = h.url_for('orgportals_pages_edit', org_name=org_name, page='/' + page.name) %}
  {% set delete_url = h.url_for('orgportals_pages_delete', org_name=org_name, page='/' + page.name) %}
{% else %}
  {% set action_url = h.url_for('orgportals_pages_edit', org_name=org_name, page='') %}
  {% set delete_url = h.url_for('orgportals_pages_delete', org_name=org_name, page='') %}
{% endif %}
{% set cancel_url = h.url_for('orgportals_pages_index', org_name=org_name) %}

{% if not page %}
  <h1>{{ _('Add page') }}</h1>
{% else %}
  <h1>{{ _('Edit page') }}</h1>
{% endif %}
{% set url_placeholder = 'eg. my-page' %}
{% set title_placeholder = _('eg. Page Title') %}


<form class="form-horizontal" method="post" action="{{ action_url }}" data-module="basic-form">
  {% block error_summary %}
    {{ form.errors(error_summary) }}
  {% endblock %}

  {% if page.id is undefined or (page.type != 'data') %}
    {{ form.input('title', id='field-title', label=_('Title'), placeholder=title_placeholder, value=page.title, error=errors.title, classes=['control-full', 'control-large'], is_required=true) }}
  {% endif %}

  {% if page.type == 'home' %}
    {{ form.input('text_box', id='field-title', label=_('Text box'), value=page.text_box, classes=['control-full'], is_required=true) }}
  {% endif %}

  {% set prefix = h.url_for(controller='ckanext.orgportals.controllers.portals:OrgportalsController', action='custompage_show', org_name=org_name, page_name='') %}
  {% set attrs = {'data-module': 'slug-preview-target'} %}

  {% if page.id is undefined or page.type == 'custom' %}
    {{ form.prepend('name', label=_('URL'), prepend=prefix, id='field-url', placeholder=_('my-page'), value=page.name, error=errors.name, attrs=attrs, is_required=true) }}
    {{ form.input('type', id='field-type', label=_('Type'), value='custom', error=errors.type, classes=['control-full', 'control-large'], is_required=true) }}
  {% endif %}

  {% if page.id is undefined or page.type == 'custom' or (page.type == 'default' and page.name != 'contact') %}
    {{ form.markdown('content', id='field-content', label=_('Content'), placeholder=_('Enter content here'), value=page.content) }}
  {% endif %}

  {% set is_upload = page.image and not page.image.startswith('http') %}
  {% set is_url = page.image and page.image.startswith('http') %}
  {% set errors = {} %}

  {# {{ form.image_upload(page, errors, is_upload_enabled=h.uploads_enabled(), is_url=is_url, is_upload=is_upload) }} #}

  {% if page.type == 'data' %}
    <fieldset class="map-properties">
      <legend>{{ _('Map options') }}</legend>

      {% if data.map %}
          {% set maps = h.orgportals_convert_to_list(data.map) %}
      {% else %}
          {% set maps = [] %}
      {% endif %}

      {% if data.map_main_property %}
          {% set map_properties = h.orgportals_convert_to_list(data.map_main_property) %}
      {% else %}
          {% set map_properties = [] %}
      {% endif %}

      {% if maps|length > 0 %}
        {% for item in maps %}
          {% set map_select_name = ['map_', loop.index] %}
          {% set map_main_property_select_name = ['map_main_property_', loop.index] %}

          <div id="map-field_{{ loop.index }}" class="map-fields">
            {{ form.select(map_select_name|join, 'map', _('Resource'), options=h.orgportals_get_org_map_views(data.org_name), selected=item) }}
            {{ form.select(map_main_property_select_name|join, 'map_main_property', _('Property'), options=h.orgportals_resource_show_map_properties(item), selected=map_properties[loop.index - 1]) }}
            <a id="remove_map_field" class="btn btn-danger"><i class="fa fa-trash" aria-hidden="true"></i> Remove </a>
            <hr>
          </div>
        {% endfor %}
      {% else %}
        <div id="map-field_1" class="map-fields">
          {{ form.select('map_1', 'map', _('Resource'), options=h.orgportals_get_org_map_views(data.org_name)) }}
          {{ form.select('map_main_property_1', 'map_main_property', _('Property')) }}
          <hr>
          <a id="remove_map_field" class="btn btn-danger"><i class="fa fa-trash" aria-hidden="true"></i> Remove </a>
        </div>
      {% endif %}
    </fieldset>

    <a id="new-field-btn" class="new-field-btn btn btn-default">Add field</a>
  {% endif %}

  <div class="form-actions">
    {% if not page %}
      <a class="btn pull-left" href="{{ cancel_url }}">{{ _('Cancel') }}</a>
      <button class="btn btn-primary" name="save" value="save" type="submit">{{ _('Add') }}</button>
    {% else %}

      {% block delete_button %}
        {% set page_types = ['home', 'data', 'default'] %}

        {% if h.check_access('orgportals_pages_delete', {'page': page.type}) and page.type not in page_types %}
          {% set locale = h.dump_json({'content': _('Are you sure you want to delete this Page?')}) %}
          <a class="btn btn-danger pull-left" href="{{ delete_url }}" data-module="confirm-action" data-module-i18n="{{ locale }}">{% block delete_button_text %}{{ _('Delete') }}{% endblock %}</a>
        {% endif %}
      {% endblock %}

      <button class="btn btn-primary" name="save" value="save" type="submit">{{ _('Save') }}</button>
    {% endif %}
  </div>

</form>
